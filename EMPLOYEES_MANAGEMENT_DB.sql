USE MASTER
IF EXISTS (SELECT name FROM master.dbo.sysdatabases WHERE name = 'EmployeesManagement')
BEGIN
	ALTER DATABASE EmployeesManagement SET OFFLINE WITH ROLLBACK IMMEDIATE;
	ALTER DATABASE EmployeesManagement SET ONLINE;
	DROP DATABASE EmployeesManagement;
END 

CREATE DATABASE EmployeesManagement;
GO
USE EmployeesManagement;
GO

CREATE TABLE ACCOUNT (
	USERNAME nvarchar(50) PRIMARY KEY,
	[PASSWORD] nvarchar(80) NOT NULL,
	EMAIL nvarchar(80) NOT NULL,	
	FULL_NAME nvarchar(80) NOT NULL,
	PHONE_NUMBER nvarchar(80) NOT NULL,
	[ROLE] nvarchar(10) NOT NULL CONSTRAINT CHECK_ROLE CHECK ([ROLE] IN ('User', 'Manager', 'Admin')),
	CREATED_DATE datetime,
	UPDATED_DATE datetime,
	DELETE_FLAG int NOT NULL DEFAULT 0 CONSTRAINT Check_SoLuongSach CHECK (DELETE_FLAG IN (0, 1)),
	ADDRESS_ID int
);
GO

CREATE TABLE [ADDRESS] (
	ADDRESS_ID int IDENTITY (1, 1) PRIMARY KEY,
	STREET nvarchar(50) NOT NULL,
	PROVINCE nvarchar(50) NOT NULL,
	CITY nvarchar(50) NOT NULL,
	WARD nvarchar(50) NOT NULL,
	UPDATED_DATE datetime
);
GO

CREATE TABLE DEPARTMENT (
	DEPARTMENT_ID int IDENTITY (1, 1) PRIMARY KEY,	
	DEPARTMENT_NAME nvarchar(50) NOT NULL,	
);
GO

CREATE TABLE JOB (
	JOB_ID int IDENTITY (1, 1) PRIMARY KEY,	
	JOB_TITLE nvarchar(50) NOT NULL,	
	SALARY int NOT NULL,	
	UPDATED_DATE datetime
);
GO


CREATE TABLE EMPLOYEE (
	EMPLOYEE_ID int IDENTITY (1, 1) PRIMARY KEY,
	HIRED_DATE DATE NOT NULL,
	USERNAME nvarchar(50) NOT NULL,
	DEPARTMENT_ID int NOT NULL,
	JOB_ID int NOT NULL,
);
GO

CREATE TABLE JOB_HISTORY (
	JOB_HISTORY_ID int IDENTITY (1, 1) PRIMARY KEY,	
	STARTED_DATE DATE NOT NULL,
	ENDED_DATE DATE,
	JOB_ID int NOT NULL,
	DEPARTMENT_ID int NOT NULL,
	EMPLOYEE_ID int NOT NULL
);
GO

ALTER TABLE ACCOUNT ADD CONSTRAINT FK_ACCOUNT_ADDRESS
					   FOREIGN KEY(ADDRESS_ID) REFERENCES [ADDRESS](ADDRESS_ID) 
GO

ALTER TABLE EMPLOYEE ADD CONSTRAINT FK_EMPLOYEE_ACCOUNT
					   FOREIGN KEY(USERNAME) REFERENCES ACCOUNT(USERNAME) 
GO

ALTER TABLE EMPLOYEE ADD CONSTRAINT FK_EMPLOYEE_DEPARTMENT
					   FOREIGN KEY(DEPARTMENT_ID) REFERENCES DEPARTMENT(DEPARTMENT_ID) 
GO

ALTER TABLE EMPLOYEE ADD CONSTRAINT FK_EMPLOYEE_JOB
					   FOREIGN KEY(JOB_ID) REFERENCES JOB(JOB_ID) 
GO

ALTER TABLE JOB_HISTORY ADD CONSTRAINT FK_JOB_HISTORY_JOB
					   FOREIGN KEY(JOB_ID) REFERENCES JOB(JOB_ID) 
GO

ALTER TABLE JOB_HISTORY ADD CONSTRAINT FK_JOB_HISTORY_DEPARTMENT
					   FOREIGN KEY(DEPARTMENT_ID) REFERENCES DEPARTMENT(DEPARTMENT_ID) 					   
GO

ALTER TABLE JOB_HISTORY ADD CONSTRAINT FK_JOB_HISTORY_EMPLOYEE
					   FOREIGN KEY(EMPLOYEE_ID) REFERENCES EMPLOYEE(EMPLOYEE_ID) 					   
GO


CREATE TRIGGER TRG_ACCOUNT_CREATED_DATE
ON ACCOUNT
AFTER INSERT
AS
BEGIN
    UPDATE A
    SET CREATED_DATE = GETDATE()
    FROM ACCOUNT A
    INNER JOIN INSERTED i ON A.USERNAME = i.USERNAME;
END;

GO

CREATE TRIGGER TRG_ACCOUNT_UPDATED_DATE
ON ACCOUNT
AFTER UPDATE
AS
BEGIN
    UPDATE A
    SET UPDATED_DATE = GETDATE()
    FROM ACCOUNT A
    INNER JOIN INSERTED i ON A.USERNAME = i.USERNAME;
END;
GO

CREATE TRIGGER TRG_ADDRESS_UPDATED_DATE
ON [ADDRESS]
AFTER UPDATE
AS
BEGIN
    UPDATE A
    SET UPDATED_DATE = GETDATE()
    FROM [ADDRESS] A
    INNER JOIN INSERTED i ON A.ADDRESS_ID = i.ADDRESS_ID;
END;
GO

CREATE TRIGGER TRG_JOB_UPDATED_DATE
ON JOB
AFTER UPDATE
AS
BEGIN
    UPDATE J
    SET UPDATED_DATE = GETDATE()
    FROM JOB J
    INNER JOIN INSERTED i ON J.JOB_ID = i.JOB_ID;
END;
GO

INSERT INTO ADDRESS (STREET,PROVINCE,CITY,WARD,UPDATED_DATE) VALUES
	 (N'D??ng Nguyen Luong Bang',N'tinh Dak Lak',N'Buon Ma Thuot',N'Hoa Thang','2024-03-06 00:49:44.060'),
	 (N'Nguyen Luong Bang',N'Dak Lak',N'BMT',N'Hoa Thang','2024-03-06 00:50:34.470'),
	 (N'Nguyen Luong Bang',N'Dak Lak',N'TP Buon Ma Thuot',N'Xa Hoa Phu','2024-02-23 23:38:23.723'),
	 (N'Nguyen Luong Bang',N'Dak Lak',N'TP Buon Ma Thuot',N'Hoa Thang','2024-02-23 23:38:54.670'),
	 (N'Nguyen Luong Bang',N'',N'',N'','2024-03-05 21:51:09.653'),
	 (N'Nguyen Luong Bang',N'tinh Dak Lak',N'TP Buon Ma Thuot',N'Hoa Thang',NULL),
	 (N'Nguyen Luong Bang',N'Dak Lak',N'TP Buon Ma Thuot',N'Hoa Thang',NULL);

INSERT INTO ACCOUNT (USERNAME,PASSWORD,EMAIL,FULL_NAME,PHONE_NUMBER,[ROLE],CREATED_DATE,UPDATED_DATE,DELETE_FLAG,ADDRESS_ID) VALUES
	 (N'admin',N'123',N'admin@gmail.com',N'Pham Hoang Tien',N'123456789',N'Admin','2024-02-20 00:36:43.280','2024-03-05 21:09:12.423',0,NULL),
	 (N'ewrrw',N'1234567A@',N'handnn@gmail.com',N'Do Nguyen Ngoc Han',N'1234',N'User','2024-02-21 23:12:02.957','2024-02-24 01:00:38.480',1,3),
	 (N'manager',N'123',N'manager@gmail.com',N'Pham Hoang Tien',N'0868363802',N'Manager','2024-02-20 00:36:43.280','2024-03-06 00:49:44.077',0,1),
	 (N'thilien',N'12345678A@',N'test@gmail.com',N'Thi Lien',N'123455667',N'Manager','2024-02-24 00:28:02.077','2024-02-24 01:01:28.870',1,NULL),
	 (N'tienph',N'123',N'tienph@gmail.com',N'Pham Hoang Tien',N'234234',N'User','2024-02-20 00:36:43.277','2024-03-06 00:50:34.480',0,2),
	 (N'tienph1',N'1234567A@',N'tienph1@gmail.com',N'Tien',N'1234',N'User','2024-03-06 00:36:03.743','2024-03-06 00:36:03.773',0,NULL),
	 (N'tienph11',N'12345678A@',N'test@gmail.com',N'test',N'12345678',N'User','2024-03-06 00:44:42.593','2024-03-06 00:45:56.627',1,6),
	 (N'tupht',N'12345678',N'tupht@gmail.com',N'Pham Hoang Thanh Tu',N'123456789',N'User','2024-02-20 00:36:43.280','2024-02-23 23:38:54.673',0,4),
	 (N'vanphuot',N'12345678@A',N'vanphuot@gmail.com',N'vanphuot',N'123452344',N'User','2024-03-06 00:03:51.827','2024-03-06 00:48:46.043',0,7),
	 (N'vanthong',N'123456789A@',N'vanthong@gmail.com',N'vanthong',N'12345678',N'User','2024-03-06 00:04:32.327','2024-03-06 00:04:32.330',0,NULL);
INSERT INTO ACCOUNT (USERNAME,PASSWORD,EMAIL,FULL_NAME,PHONE_NUMBER,[ROLE],CREATED_DATE,UPDATED_DATE,DELETE_FLAG,ADDRESS_ID) VALUES
	 (N'vanviet',N'123456A@',N'vanviet@gmail.com',N'Van Viet',N'12345',N'User','2024-02-24 00:27:26.540','2024-03-05 21:51:09.660',0,5);
	 
INSERT INTO DEPARTMENT (DEPARTMENT_NAME) VALUES
	 (N'Human Resources'),
	 (N'Sales'),
	 (N'Marketing'),
	 (N'Software Engineering'),
	 (N'Update');
	
INSERT INTO JOB (JOB_TITLE,SALARY,UPDATED_DATE) VALUES
	 (N'Developer',1700,'2024-03-06 00:46:32.763'),
	 (N'Data Analyst',1200,NULL),
	 (N'Project Manager',2000,NULL),
	 (N'Sales Representative',1000,NULL),
	 (N'Marketing Specialist',1100,NULL);
		
INSERT INTO EMPLOYEE (HIRED_DATE,USERNAME,DEPARTMENT_ID,JOB_ID) VALUES
	 ('2024-02-14',N'tienph',4,1),
	 ('2024-02-01',N'ewrrw',2,5),
	 ('2023-11-29',N'tupht',2,5),
	 ('2024-01-03',N'vanviet',4,3),
	 ('2024-02-09',N'tienph1',4,1),
	 ('2024-02-01',N'vanphuot',4,3);


INSERT INTO JOB_HISTORY (STARTED_DATE,ENDED_DATE,JOB_ID,DEPARTMENT_ID,EMPLOYEE_ID) VALUES
	 ('2024-02-14','2024-02-22',3,4,1),
	 ('2024-02-01','2024-02-22',5,1,2),
	 ('2023-11-29',NULL,5,2,3),
	 ('2024-02-22',NULL,1,4,1),
	 ('2024-02-22',NULL,5,2,2),
	 ('2024-01-03',NULL,3,4,4),
	 ('2024-02-09',NULL,1,4,5),
	 ('2024-02-01','2024-03-06',1,4,6),
	 ('2024-03-06',NULL,3,4,6);

